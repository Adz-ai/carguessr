let currentGame={mode:null,difficulty:"easy",currentListing:null,score:0,sessionId:generateSessionId(),challengeSession:null,challengeGuesses:[],pendingLeaderboardData:null,leaderboardShownAfterSubmission:!1},leaderboardState={currentGameMode:"challenge",currentDifficulty:"easy"};function generateSessionId(){var t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let n="";for(let e=0;e<16;e++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function saveDifficultyPreference(e){try{localStorage.setItem("carguessr_difficulty",e)}catch(e){console.log("Unable to save difficulty preference:",e)}}function loadDifficultyPreference(){try{return localStorage.getItem("carguessr_difficulty")||"easy"}catch(e){return console.log("Unable to load difficulty preference:",e),"easy"}}function selectDifficulty(e){currentGame.difficulty=e,saveDifficultyPreference(leaderboardState.currentDifficulty=e),document.getElementById("easyButton").classList.remove("active"),document.getElementById("hardButton").classList.remove("active"),"easy"===e?(document.getElementById("easyButton").classList.add("active"),document.getElementById("difficultyDescription").innerHTML="<strong>Easy Mode:</strong> Modern used cars from Lookers dealership. Realistic pricing from a major UK car dealer - perfect for beginners!"):(document.getElementById("hardButton").classList.add("active"),document.getElementById("difficultyDescription").innerHTML="<strong>Hard Mode:</strong> Classic and exotic cars from Bonhams auction house. Higher value cars with unique characteristics - the ultimate challenge!")}function startGame(e){currentGame.mode=e,currentGame.score=0,document.getElementById("modeSelection").style.display="none",document.getElementById("gameArea").style.display="block",document.getElementById("scoreDisplay").style.display="inline-block";var t=document.getElementById("scoreLabel");"zero"===e?t.textContent="Total Difference: £":"streak"===e?t.textContent="Streak: ":"challenge"===e&&(t.textContent="Score: "),("challenge"===e?startChallengeMode:loadNextCar)()}async function loadNextCar(){try{var t=currentGame.difficulty?"?difficulty="+currentGame.difficulty:"",n={};currentGame.sessionId&&(n["X-Session-ID"]=currentGame.sessionId);let e=await fetch("/api/random-enhanced-listing"+t,{headers:n});if(!e.ok&&(console.log("Enhanced listing not available, falling back to standard"),!(e=await fetch("/api/random-listing",{headers:n})).ok))throw new Error("Failed to load listing");var a=await e.json(),l=(displayCar(currentGame.currentListing=a),document.getElementById("priceGuess")),o=document.getElementById("priceOverlay");l.value="",document.getElementById("priceSlider").value=50,o.textContent="Enter price",o.style.color="rgba(255, 255, 255, 0.5)",o.style.fontStyle="italic"}catch(e){console.error("Error loading car:",e),alert("Failed to load car listing. Please try again.")}}function displayCar(l){let o=document.querySelector(".car-display");o.style.opacity="0",o.style.transform="translateY(20px)",setTimeout(()=>{setupImageGallery(l.images||[]);let e;e=!l.auctionDetails&&l.fullTitle&&l.fullTitle.includes(" - ")?l.fullTitle.split(" - ")[0]:`${l.year||"Unknown"} ${l.make||"Unknown"} `+(l.model||"Unknown"),document.getElementById("carTitle").textContent=e;var t=document.getElementById("trimRow"),n=document.getElementById("carTrim"),n=(!l.auctionDetails&&l.trim&&""!==l.trim?(n.textContent=l.trim,t.style.display="flex"):t.style.display="none",[{id:"carYear",value:l.year||"Unknown"},{id:"carEngine",value:l.engine||"Unknown"},{id:"carMileage",value:l.mileageFormatted||(l.mileage?l.mileage.toLocaleString()+" miles":"Unknown")},{id:"carTrim",value:l.trim||"Unknown"},{id:"carOwners",value:l.owners||"Unknown"},{id:"carFuelType",value:l.fuelType||"Unknown"},{id:"carBodyType",value:l.bodyType||"Unknown"},{id:"carGearbox",value:l.gearbox||"Unknown"},{id:"carDoors",value:l.doors||"Unknown"},{id:"carBodyColour",value:l.bodyColour||l.exteriorColor||"Unknown"},{id:"carLocation",value:l.location||"Unknown"}]);if(l.auctionDetails){document.getElementById("ownersRow").style.display="none",document.getElementById("bodyTypeRow").style.display="none",document.getElementById("doorsRow").style.display="none";var t=document.getElementById("saleDateRow"),a=document.getElementById("carSaleDate"),a=(l.saleDate?(a.textContent=l.saleDate,t.style.display="flex"):t.style.display="none",document.getElementById("locationRow")),t=document.getElementById("carLocation"),t=(l.location?(t.textContent=l.location,a.style.display="flex"):a.style.display="none",document.getElementById("interiorColorRow")),a=document.getElementById("carInteriorColor"),a=(l.interiorColor?(a.textContent=l.interiorColor,t.style.display="flex"):t.style.display="none",document.getElementById("steeringRow")),t=document.getElementById("carSteering");l.steering?(t.textContent=l.steering,a.style.display="flex"):a.style.display="none";document.getElementById("auctionDetailsSection").style.display="block";t=document.getElementById("keyFactsSection");let n=document.getElementById("keyFactsList");l.keyFacts&&0<l.keyFacts.length?(n.innerHTML="",l.keyFacts.forEach(e=>{var t=document.createElement("li");t.textContent=e,n.appendChild(t)}),t.style.display="block"):t.style.display="none"}else{a=document.getElementById("ownersRow"),t=(l.owners&&"Unknown"!==l.owners?a.style.display="flex":a.style.display="none",document.getElementById("bodyTypeRow")),a=(l.bodyType&&"Unknown"!==l.bodyType?t.style.display="flex":t.style.display="none",document.getElementById("doorsRow")),t=(l.doors&&"Unknown"!==l.doors?a.style.display="flex":a.style.display="none",document.getElementById("locationRow"));l.location&&"Unknown"!==l.location?t.style.display="flex":t.style.display="none",document.getElementById("saleDateRow").style.display="none",document.getElementById("interiorColorRow").style.display="none",document.getElementById("steeringRow").style.display="none",document.getElementById("auctionDetailsSection").style.display="none"}n.forEach((e,t)=>{let n=document.getElementById(e.id);n.style.opacity="0",setTimeout(()=>{n.textContent=e.value,n.style.transition="opacity 0.3s ease",n.style.opacity="1"},50*t)}),o.style.transition="all 0.5s ease",o.style.opacity="1",o.style.transform="translateY(0)"},100)}function handleImageError(e,t){console.log("Image failed to load:",t),currentGame&&"easy"===currentGame.difficulty&&(t=document.getElementById("europeWarning"))&&"none"===t.style.display&&(t.style.display="flex"),e.src="https://www.travelodge.co.uk/nw/assets/img/photo/image-unavailable.png",e.style.filter="grayscale(1)"}function setupImageGallery(e){let t=document.getElementById("mainCarImage"),a=document.getElementById("thumbnailStrip");a.innerHTML="",0===e.length?t.src="https://www.travelodge.co.uk/nw/assets/img/photo/image-unavailable.png":(t.style.opacity="0",setTimeout(()=>{t.src=e[0],t.onerror=()=>handleImageError(t,e[0]),t.style.opacity="1"},200),1<e.length?(e.forEach((e,t)=>{let n=document.createElement("img");n.src=e,n.onerror=()=>handleImageError(n,e),n.className="thumbnail"+(0===t?" active":""),n.onclick=()=>switchMainImage(e,n),n.style.opacity="0",n.style.transform="translateY(20px)",a.appendChild(n),setTimeout(()=>{n.style.transition="all 0.3s ease",n.style.opacity="",n.style.transform=""},50*t)}),a.style.display="flex"):a.style.display="none")}function switchMainImage(e,t){let n=document.getElementById("mainCarImage");n.style.opacity="0",setTimeout(()=>{n.src=e,n.onerror=()=>handleImageError(n,e),n.style.opacity="1"},200),document.querySelectorAll(".thumbnail").forEach(e=>{e.classList.remove("active"),e.style.transform=""}),t.classList.add("active"),t.style.transform="scale(1.1)"}function priceToSlider(e){return e<=1e5?e/1e5*50:50+Math.min(e-1e5,4e5)/4e5*50}function sliderToPrice(e){return e<=50?e/50*1e5:1e5+4e5*((e-50)/50)}function syncInputToSlider(){var e,t=document.getElementById("priceGuess"),n=document.getElementById("priceSlider"),a=document.getElementById("priceOverlay"),t=t.value;isNaN(t)||""===t?(a.textContent="Enter price",a.style.color="rgba(255, 255, 255, 0.5)",a.style.fontStyle="italic"):(t=parseInt(t),e=Math.min(Math.max(t,0),5e5),n.value=priceToSlider(e),a.textContent=t.toLocaleString(),a.style.color="#fff",a.style.fontStyle="normal")}function syncSliderToInput(){var e=document.getElementById("priceGuess"),t=document.getElementById("priceSlider"),n=document.getElementById("priceOverlay"),t=parseFloat(t.value),t=Math.round(sliderToPrice(t));e.value=t,n.textContent=t.toLocaleString(),n.style.color="#fff",n.style.fontStyle="normal"}async function submitGuess(){var e=document.getElementById("priceGuess").value,e=parseInt(e),t=document.querySelector(".submit-button");if(!e||e<=0){let e=document.getElementById("priceGuess");e.style.animation="shake 0.5s",void setTimeout(()=>e.style.animation="",500)}else if("challenge"===currentGame.mode)await submitChallengeGuess(e);else{t.innerHTML='<span class="loading"></span>',t.disabled=!0;try{var n=await fetch("/api/check-guess",{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":currentGame.sessionId},body:JSON.stringify({listingId:currentGame.currentListing.id,guessedPrice:e,gameMode:currentGame.mode,difficulty:currentGame.difficulty})});if(!n.ok)throw new Error("Failed to submit guess");displayResult(await n.json())}catch(e){console.error("Error submitting guess:",e),alert("Failed to submit guess. Please try again.")}finally{t.innerHTML="Submit Guess",t.disabled=!1}}}function displayResult(t){currentGame.score=t.score,document.getElementById("scoreValue").textContent="zero"===currentGame.mode?t.score.toLocaleString():t.score,document.getElementById("resultTitle").textContent=t.correct?"Good Guess!":"Game Over!",document.getElementById("actualPrice").textContent="£"+t.actualPrice.toLocaleString(),document.getElementById("yourGuess").textContent="£"+t.guessedPrice.toLocaleString(),document.getElementById("priceDifference").textContent="£"+t.difference.toLocaleString(),document.getElementById("accuracy").textContent=(100-t.percentage).toFixed(1)+"% accurate",document.getElementById("resultMessage").textContent=t.message;var n=document.getElementById("originalLink");if(t.originalUrl){n.style.display="block";let e="View Original Listing";t.originalUrl.includes("bonhams")?e="View Original Auction Listing on Bonhams":t.originalUrl.includes("lookers")&&(e="View Original Listing on Lookers"),n.innerHTML=`<a href="${t.originalUrl}" target="_blank" class="original-link">${e}</a>`}else n.style.display="none";t.gameOver?(document.getElementById("finalScore").textContent="zero"===currentGame.mode?"Total Difference: £"+t.score.toLocaleString():"Final Streak: "+t.score,n=document.getElementById("submitStreakScore"),"streak"===currentGame.mode&&0===t.score?n.style.display="none":n.style.display="",lockBodyScroll(),document.getElementById("gameOverModal").style.display="flex"):(lockBodyScroll(),document.getElementById("resultModal").style.display="flex")}function nextRound(){var e,t;document.getElementById("resultModal").style.display="none",unlockBodyScroll(),("challenge"===currentGame.mode?(e=currentGame.challengeSession?currentGame.challengeSession.currentCar:0,t=currentGame.challengeGuesses?currentGame.challengeGuesses.length:0,console.log("Next round analysis:",{currentCarNum:e,totalGuesses:t,sessionComplete:currentGame.challengeSession?currentGame.challengeSession.isComplete:"unknown",sessionData:currentGame.challengeSession}),currentGame.challengeSession&&!0===currentGame.challengeSession.isComplete?(console.log("Challenge complete! Showing results..."),displayChallengeResults):(console.log("Loading next challenge car..."),loadChallengeAuto(),updateChallengeProgress(),scrollToCarImage)):(loadNextCar(),scrollToCarImage))()}function scrollToCarImage(){setTimeout(()=>{var e=document.getElementById("mainCarImage");e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},300)}function endGame(){location.reload()}async function startChallengeMode(){try{var e=currentGame.difficulty?"?difficulty="+currentGame.difficulty:"",t=await fetch("/api/challenge/start"+e,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to start challenge");var n=await t.json();currentGame.challengeSession=n,currentGame.sessionId=n.sessionId,currentGame.challengeGuesses=[],loadChallengeAuto(),addChallengeProgress()}catch(e){console.error("Error starting challenge:",e),alert("Failed to start challenge mode. Please try again."),location.reload()}}async function initializeChallenge(e){try{var t=await fetch("/api/challenge/"+e);if(!t.ok)throw new Error("Failed to load challenge session");var n=await t.json();currentGame.mode="challenge",currentGame.difficulty=n.difficulty,currentGame.score=n.totalScore||0,currentGame.sessionId=n.sessionId,currentGame.challengeSession=n,currentGame.challengeGuesses=n.guesses||[],document.getElementById("scoreDisplay").style.display="inline-block",document.getElementById("scoreLabel").textContent="Challenge Score: ",document.getElementById("scoreValue").textContent=currentGame.score,loadChallengeAuto(),addChallengeProgress()}catch(e){console.error("Error initializing challenge:",e),alert("Failed to load challenge. Please try again."),location.reload()}}function addChallengeProgress(){var e=document.querySelector(".car-info"),t=document.createElement("div"),n=(t.className="challenge-progress",t.id="challengeProgress",currentGame.challengeSession),a=n.currentCar+1;t.innerHTML=`
        <h4>Challenge Progress</h4>
        <p>Car ${a} of 10</p>
        <div class="challenge-progress-bar">
            <div class="challenge-progress-fill" style="width: ${(a-1)/10*100}%"></div>
        </div>
        <p>Current Score: <span id="challengeCurrentScore">${n.totalScore}</span> points</p>
    `,e.appendChild(t)}function updateChallengeProgress(){var e=currentGame.challengeSession,t=e.currentCar+1,n=document.getElementById("challengeProgress");n&&(n.innerHTML=`
            <h4>Challenge Progress</h4>
            <p>Car ${t} of 10</p>
            <div class="challenge-progress-bar">
                <div class="challenge-progress-fill" style="width: ${(t-1)/10*100}%"></div>
            </div>
            <p>Current Score: <span id="challengeCurrentScore">${e.totalScore}</span> points</p>
        `)}async function loadChallengeAuto(){let t=currentGame.challengeSession;if(!t||!t.cars||0===t.cars.length){console.log("Challenge session missing or incomplete, fetching from backend...");let e=currentGame.sessionId;if(!(e=!e&&t?t.sessionId:e))return console.error("No session ID available to fetch challenge data"),void alert("Challenge session error. Please refresh and try again.");try{var n=await fetch("/api/challenge/"+e);if(!n.ok)throw new Error("Failed to fetch challenge session");var a=await n.json();currentGame.challengeSession=a,t=a,console.log("Fetched challenge session:",t)}catch(e){return console.error("Error fetching challenge session:",e),void alert("Failed to load challenge data. Please refresh and try again.")}}t.currentCar>=t.cars.length?console.log("All cars completed"):(n=t.cars[t.currentCar],displayCar(currentGame.currentListing=n),a=document.getElementById("priceGuess"),n=document.getElementById("priceOverlay"),a.value="",document.getElementById("priceSlider").value=25,n.textContent="Enter price",n.style.color="rgba(255, 255, 255, 0.5)",n.style.fontStyle="italic")}async function submitChallengeGuess(t){var e=document.querySelector(".submit-button");e.innerHTML='<span class="loading"></span>',e.disabled=!0;try{currentGame.challengeSession||(currentGame.challengeSession={sessionId:null,currentCar:0,totalScore:0,guesses:[]});let e=currentGame.sessionId;if(!(e=!e&&currentGame.challengeSession?currentGame.challengeSession.sessionId:e))throw console.error("No session ID available for challenge guess"),new Error("Session not properly initialized");console.log("Submitting challenge guess with session ID:",e);var n,a=await fetch(`/api/challenge/${e}/guess`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guessedPrice:t})});if(console.log("Challenge guess response status:",a.status),!a.ok)throw n=await a.text(),console.error("Challenge guess failed:",n),new Error("Server error: "+a.status);var l=await a.json();console.log("Challenge guess result:",l),console.log("currentGame.challengeSession before initialization:",currentGame.challengeSession),currentGame.challengeSession||(currentGame.challengeSession={sessionId:e,currentCar:0,totalScore:0,guesses:[],isComplete:!1}),currentGame.challengeSession.guesses||(currentGame.challengeSession.guesses=[]),"number"!=typeof currentGame.challengeSession.currentCar&&(currentGame.challengeSession.currentCar=0),"number"!=typeof currentGame.challengeSession.totalScore&&(currentGame.challengeSession.totalScore=0),currentGame.challengeGuesses||(currentGame.challengeGuesses=[]),currentGame.challengeGuesses.push(l),currentGame.challengeSession.currentCar++,currentGame.challengeSession.totalScore=l.totalScore,currentGame.challengeSession.guesses.push(l),!0===l.sessionComplete&&(currentGame.challengeSession.isComplete=!0),!0===l.isLastCar&&(currentGame.challengeSession.isComplete=!0),console.log("Updated challenge session:",{currentCar:currentGame.challengeSession.currentCar,totalScore:currentGame.challengeSession.totalScore,isComplete:currentGame.challengeSession.isComplete,sessionComplete:l.sessionComplete,isLastCar:l.isLastCar}),document.getElementById("scoreValue").textContent=l.totalScore,displayChallengeResult(l)}catch(e){console.error("Challenge guess submission error:",e),alert("Failed to submit guess: "+e.message)}finally{e.innerHTML="Submit Guess",e.disabled=!1}}function displayChallengeResult(t){var n=currentGame.challengeSession?currentGame.challengeSession.currentCar:t.nextCarNumber||1,n=(document.getElementById("resultTitle").textContent=`Car ${n}/10 Complete!`,document.getElementById("actualPrice").textContent="£"+t.actualPrice.toLocaleString(),document.getElementById("yourGuess").textContent="£"+t.guessedPrice.toLocaleString(),document.getElementById("priceDifference").textContent="£"+t.difference.toLocaleString(),document.getElementById("accuracy").textContent=(100-t.percentage).toFixed(1)+"% accurate",document.getElementById("resultMessage").innerHTML=`
        <strong>${t.points} points!</strong><br>
        ${t.message}
    `,document.getElementById("originalLink"));if(t.originalUrl){n.style.display="block";let e="View Original Listing";t.originalUrl.includes("bonhams")?e="View Original Auction Listing on Bonhams":t.originalUrl.includes("lookers")&&(e="View Original Listing on Lookers"),n.innerHTML=`<a href="${t.originalUrl}" target="_blank" class="original-link">${e}</a>`}else n.style.display="none";var n=document.querySelector(".next-button"),e=!0===t.isLastCar||!0===t.sessionComplete;n.textContent=e?"View Results":"Next Car",console.log("Challenge result analysis:",{isLastCar:t.isLastCar,sessionComplete:t.sessionComplete,currentCar:currentGame.challengeSession?currentGame.challengeSession.currentCar:"unknown",nextCarNumber:t.nextCarNumber,finalDecision:e}),lockBodyScroll(),document.getElementById("resultModal").style.display="flex"}function displayChallengeResults(){var e=currentGame.challengeSession;if(e){console.log("Displaying challenge results for session:",e);var t=e.totalScore||0;document.getElementById("challengeFinalScore").textContent=`Final Score: ${t.toLocaleString()} points`;let o=document.getElementById("challengeResults");o.innerHTML="";t=e.guesses||currentGame.challengeGuesses||[];let r=e.cars||[];console.log("Results breakdown:",{guessesCount:t.length,carsCount:r.length}),0===t.length?o.innerHTML='<div class="no-results">No guesses recorded</div>':t.forEach((e,t)=>{var n,a,l=r[t];l?((n=document.createElement("div")).className="challenge-result-item",a=(100-e.percentage).toFixed(1),n.innerHTML=`
                <div class="challenge-result-car">${l.year||""} ${l.make||""} ${l.model||"Unknown Car"}</div>
                <div class="challenge-result-accuracy">${a}% accurate</div>
                <div class="challenge-result-points">${e.points||0} pts</div>
            `,o.appendChild(n)):console.warn("No car data for guess "+(t+1))});t=document.querySelector("#challengeCompleteModal .submit-score-button");0===e.totalScore?t.style.display="none":t.style.display="",document.getElementById("challengeCompleteModal").style.display="flex"}else console.error("No challenge session available for results display"),alert("Error: Challenge session not found. Please try again."),location.reload()}function showNameInputModal(e){var t=window.authFunctions&&window.authFunctions.currentUser();let n=0,a=null;"challenge"===e?currentGame.challengeSession&&(n=currentGame.challengeSession.totalScore,a=currentGame.challengeSession.sessionId):"streak"===e&&(n=currentGame.score,a=currentGame.sessionId),currentGame.pendingLeaderboardData={gameMode:e,score:n,sessionId:a},t?(e=t.displayName||t.username,console.log("Auto-submitting leaderboard for logged-in user:",e),autoSubmitForLoggedInUser(e)):(document.getElementById("challengeCompleteModal").style.display="none",document.getElementById("gameOverModal").style.display="none",document.getElementById("nameInputModal").style.display="flex",setTimeout(()=>{document.getElementById("playerName").focus()},100))}async function autoSubmitForLoggedInUser(t){if(currentGame.pendingLeaderboardData)try{var e,n={name:t,score:parseInt(currentGame.pendingLeaderboardData.score)||0,gameMode:currentGame.pendingLeaderboardData.gameMode,difficulty:currentGame.difficulty||"hard",sessionId:currentGame.pendingLeaderboardData.sessionId||""},a=await fetch("/api/leaderboard/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw e=await a.json(),new Error(e.error||"Failed to submit score");var l=await a.json(),o=(console.log("Score submitted successfully for logged-in user:",l),document.getElementById("challengeCompleteModal").style.display="none",document.getElementById("gameOverModal").style.display="none",currentGame.leaderboardShownAfterSubmission=!0,console.log("Setting leaderboardShownAfterSubmission to true for auto-submit"),currentGame.pendingLeaderboardData.gameMode);console.log("Showing leaderboard modal with game mode:",o),document.getElementById("leaderboardModal").style.display="flex",lockBodyScroll(),showLeaderboard(o)}catch(e){console.error("Failed to auto-submit score:",e),document.getElementById("challengeCompleteModal").style.display="none",document.getElementById("gameOverModal").style.display="none",document.getElementById("nameInputModal").style.display="flex",document.getElementById("playerName").value=t,setTimeout(()=>{document.getElementById("playerName").focus()},100)}else console.error("No score data available for auto-submission")}function showNameInputModalFromGameOver(){showNameInputModal("streak")}async function submitToLeaderboard(){let e=document.getElementById("playerName");var t=e.value.trim();if(t)if(20<t.length)alert("Name must be 20 characters or less");else if(currentGame.pendingLeaderboardData)try{var n,a={name:t,score:parseInt(currentGame.pendingLeaderboardData.score)||0,gameMode:currentGame.pendingLeaderboardData.gameMode,difficulty:currentGame.difficulty||"hard",sessionId:currentGame.pendingLeaderboardData.sessionId||""},l=await fetch("/api/leaderboard/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!l.ok)throw n=await l.json(),new Error(n.error||"Failed to submit score");var o=await l.json();document.getElementById("nameInputModal").style.display="none",showLeaderboardWithHighlight(o.entry,o.position)}catch(e){console.error("Error submitting score:",e),alert("Failed to submit score: "+e.message)}else alert("No score data available");else e.style.animation="shake 0.5s",setTimeout(()=>e.style.animation="",500)}function skipLeaderboard(){document.getElementById("nameInputModal").style.display="none",currentGame.pendingLeaderboardData=null,location.reload()}function lockBodyScroll(){document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"}function unlockBodyScroll(){document.body.style.overflow="",document.body.style.position="",document.body.style.width=""}function openLeaderboard(){currentGame.leaderboardShownAfterSubmission=!1,leaderboardState.currentDifficulty=currentGame.difficulty,lockBodyScroll(),document.getElementById("leaderboardModal").style.display="flex",showLeaderboard("challenge")}function closeLeaderboard(){document.getElementById("leaderboardModal").style.display="none",unlockBodyScroll(),console.log("Closing leaderboard, leaderboardShownAfterSubmission:",currentGame.leaderboardShownAfterSubmission),currentGame.leaderboardShownAfterSubmission&&(console.log("Reloading page to go back to homepage"),currentGame={mode:"challenge",difficulty:"hard",score:0,sessionId:generateSessionId(),challengeSession:null,challengeGuesses:[],pendingLeaderboardData:null,leaderboardShownAfterSubmission:!1},location.reload())}async function showLeaderboard(e){leaderboardState.currentGameMode=e,document.getElementById("challengeTab").classList.remove("active"),document.getElementById("streakTab").classList.remove("active"),document.getElementById(e+"Tab").classList.add("active"),document.getElementById("hardDifficultyTab").classList.remove("active"),document.getElementById("easyDifficultyTab").classList.remove("active"),document.getElementById(leaderboardState.currentDifficulty+"DifficultyTab").classList.add("active"),await loadLeaderboardData()}async function toggleDifficultyFilter(e){leaderboardState.currentDifficulty=e,document.getElementById("hardDifficultyTab").classList.remove("active"),document.getElementById("easyDifficultyTab").classList.remove("active"),document.getElementById(e+"DifficultyTab").classList.add("active"),await loadLeaderboardData()}async function loadLeaderboardData(){var t=document.getElementById("leaderboardContent");t.innerHTML='<div class="leaderboard-empty">Loading...</div>';try{var e=`/api/leaderboard?mode=${leaderboardState.currentGameMode}&difficulty=${leaderboardState.currentDifficulty}&limit=10`,n=await fetch(e);if(!n.ok)throw new Error("Failed to load leaderboard");displayLeaderboardEntries(await n.json(),leaderboardState.currentGameMode,leaderboardState.currentDifficulty)}catch(e){console.error("Error loading leaderboard:",e),t.innerHTML='<div class="leaderboard-empty">Failed to load leaderboard</div>'}}function displayLeaderboardEntries(e,r,t){var n=document.getElementById("leaderboardContent");if(0===e.length)n.innerHTML=`
            <div class="leaderboard-empty">
                <p>No ${"challenge"===r?"Challenge":"Streak"} Mode scores yet for ${"easy"===t?"Easy":"Hard"} difficulty!</p>
                <p>Be the first to submit a score!</p>
            </div>
        `;else{let o="";e.forEach((e,t)=>{var t=t+1,n=t<=3,a="challenge"===r?e.score.toLocaleString()+" pts":e.score+" streak",l=new Date(e.date).toLocaleDateString();o+=`
            <div class="leaderboard-entry ${n?"top-3":""}">
                <div class="leaderboard-rank ${n?"top-3":""}">${getRankDisplay(t)}</div>
                <div class="leaderboard-name">${escapeHtml(e.name)}</div>
                <div class="leaderboard-score">${a}</div>
                <div class="leaderboard-date">${l}</div>
            </div>
        `}),n.innerHTML=o}}async function showLeaderboardWithHighlight(e,t){currentGame.leaderboardShownAfterSubmission=!0,document.getElementById("leaderboardModal").style.display="flex",showLeaderboard(e.gameMode),setTimeout(()=>{var e=document.querySelectorAll(".leaderboard-entry");e[t-1]&&(e[t-1].style.background="linear-gradient(135deg, rgba(32, 178, 170, 0.3) 0%, rgba(65, 105, 225, 0.3) 100%)",e[t-1].style.borderColor="#20b2aa",e[t-1].scrollIntoView({behavior:"smooth",block:"center"}))},500)}function getRankDisplay(e){switch(e){case 1:return"🥇";case 2:return"🥈";case 3:return"🥉";default:return"#"+e}}function escapeHtml(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}window.onclick=function(e){e.target.classList.contains("modal")&&("leaderboardModal"===e.target.id?closeLeaderboard():e.target.style.display="none")},document.addEventListener("DOMContentLoaded",()=>{var e=loadDifficultyPreference(),e=(currentGame.difficulty=e,selectDifficulty(leaderboardState.currentDifficulty=e),document.getElementById("hardDifficultyTab").classList.remove("active"),document.getElementById("easyDifficultyTab").classList.remove("active"),document.getElementById(e+"DifficultyTab").classList.add("active"),document.createElement("style")),e=(e.innerHTML=`
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        .main-car-image { transition: opacity 0.3s ease; }
        .detail-value { transition: opacity 0.3s ease; }
    `,document.head.appendChild(e),document.getElementById("priceGuess")),t=document.getElementById("priceSlider"),e=(e.addEventListener("keypress",function(e){"Enter"===e.key&&submitGuess()}),e.addEventListener("input",syncInputToSlider),t.addEventListener("input",syncSliderToInput),document.getElementById("playerName"));e&&e.addEventListener("keypress",function(e){"Enter"===e.key&&submitToLeaderboard()}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();e=document.querySelector(this.getAttribute("href"));e&&e.scrollIntoView({behavior:"smooth"})})})});